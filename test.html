<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Electricity & Solar – Mobile</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 16px rgba(0,0,0,.06); padding:1rem; }
    .kpi { font-size:1.5rem; font-weight:700; }
    .kpi-label { font-size:.72rem; text-transform:uppercase; letter-spacing:.06em; color:#6b7280; }
    .input { border:1px solid #e5e7eb; border-radius:.75rem; padding:.6rem .85rem; width:100%; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .tab-active { color:#111827; font-weight:600; }
    .tab-icon { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:.75rem; gap:2px; }
    .tab-icon svg { width:20px; height:20px; stroke-width:2; }
    .tab-fab { background:#10b981; color:#fff; border-radius:50%; width:56px; height:56px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-top:-28px; }
    body { padding-bottom: calc(76px + var(--safe-bottom)); }
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    .ok{color:#065f46}.bad{color:#991b1b}
    .warn { background:#FEF3C7; color:#92400E; border:1px solid #FDE68A; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="px-4 pt-4 pb-2 flex items-center justify-between gap-3">
    <div>
      <h1 class="text-xl font-bold">Household Electricity & Solar</h1>
      <p class="text-xs text-gray-600">Mobile PWA. Reads your Google Sheet.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="signInBtn" type="button" class="px-3 py-2 rounded-xl bg-gray-900 text-white text-sm">Sign in</button>
      <button id="signOutBtn" type="button" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm hidden">Sign out</button>
    </div>
  </header>

  <!-- Install banner -->
  <div id="installBanner" class="hidden mx-4 mb-2 p-3 rounded-xl bg-white border border-gray-200 flex items-center justify-between">
    <span class="text-sm">Add this app to your home screen</span>
    <div class="flex gap-2">
      <button id="installBtn" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">Install</button>
      <button id="dismissInstall" class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm">Not now</button>
    </div>
  </div>

  <!-- Sections -->
  <main class="px-4 pb-24 space-y-4">
    <!-- KPIs -->
    <section id="sec-kpi" class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div class="card"><div class="kpi" id="kpiUsage">0 kWh</div><div class="kpi-label">Total Usage</div></div>
        <div class="card"><div class="kpi" id="kpiSolar">0 kWh</div><div class="kpi-label">Total Solar</div></div>
        <div class="card"><div class="kpi" id="kpiImport">0 kWh</div><div class="kpi-label">Grid Import</div></div>
        <div class="card"><div class="kpi" id="kpiExport">0 kWh</div><div class="kpi-label">Grid Export</div></div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div class="card"><div class="kpi" id="kpiSelfConsumption">0%</div><div class="kpi-label">Self Consumption</div></div>
        <div class="card"><div class="kpi" id="kpiSelfSufficiency">0%</div><div class="kpi-label">Self Sufficiency</div></div>
        <div class="card"><div class="kpi" id="kpiAvgDailyUse">0 kWh</div><div class="kpi-label">Avg Daily Usage</div></div>
        <div class="card"><div class="kpi" id="kpiSavings">$0</div><div class="kpi-label">Est. Savings</div></div>
      </div>
    </section>

    <!-- Charts -->
    <section id="sec-charts" class="hidden space-y-3">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Monthly Usage and Solar</h2>
          <button id="refreshBtn" type="button" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm">Refresh</button>
        </div>
        <canvas id="chartMonthly" class="mt-3"></canvas>
      </div>
    </section>

    <!-- Data table -->
    <section id="sec-data" class="hidden space-y-3">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Data</h2>
          <a id="sheetLink" href="#" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-lg bg-gray-200 text-sm">Open Sheet</a>
        </div>
        <div class="overflow-x-auto mt-2">
          <table class="min-w-full text-sm" id="dataTable">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="text-left p-2">Date</th>
                <th class="text-right p-2">Home kWh</th>
                <th class="text-right p-2">Solar kWh</th>
                <th class="text-right p-2">Grid Import</th>
                <th class="text-right p-2">Grid Export</th>
                <th class="text-right p-2">Solar → Load</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Entry tab -->
    <section id="sec-entry" class="hidden space-y-3">
      <div class="card">
        <h2 class="font-semibold mb-2">Append new solar readings</h2>
        <p class="text-xs text-gray-600 mb-3">Writes to Columns A to C in your Data sheet. Uses Google sign in.</p>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="block"><span class="text-sm text-gray-700">Date (A)</span><input id="inDate" type="date" class="input" /></label>
          <label class="block"><span class="text-sm text-gray-700">ITD Production (B)</span><input id="inITD" type="number" step="any" class="input" placeholder="12345" /></label>
          <label class="block"><span class="text-sm text-gray-700">Daily Production (C)</span><input id="inProd" type="number" step="any" class="input" placeholder="kWh" /></label>
        </div>
        <div class="flex items-center gap-3 mt-3">
          <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700" disabled>Append Row</button>
          <button id="entryRefreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh last row</button>
          <span id="status" class="text-sm"></span>
        </div>
      </div>
      <div class="card">
        <h2 class="font-semibold mb-2">Last row where Column A is not blank</h2>
        <div class="overflow-auto border border-gray-200 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
            <tbody><tr id="lastBody"></tr></tbody>
          </table>
        </div>
        <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
      </div>
      <div class="card">
        <h2 class="text-sm font-semibold mb-1">Diagnostics</h2>
        <pre id="diag" class="mono text-xs whitespace-pre-wrap"></pre>
      </div>
    </section>

    <!-- Settings (data source and filters) -->
    <section id="sec-settings" class="hidden space-y-3">
      <div class="card" id="dataSourceCard">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Data Source</h2>
          <button id="toggleDataSource" type="button" class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm" aria-expanded="false" aria-controls="dataSourceBody">Show</button>
        </div>
        <div id="dataSourceBody" class="mt-3 hidden">
          <div class="grid grid-cols-1 gap-3">
            <label class="block"><span class="text-sm text-gray-700">Google Sheet ID</span>
              <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac" />
            </label>
            <label class="block"><span class="text-sm text-gray-700">Sheet name for dashboard</span>
              <input id="sheetName" class="input" value="FullReport" />
            </label>
            <label class="block"><span class="text-sm text-gray-700">Entry sheet name (A to C)</span>
              <input id="entrySheetName" class="input" value="Data" />
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="block"><span class="text-sm text-gray-700">Date column</span><select id="mapDate" class="input"></select></label>
              <label class="block"><span class="text-sm text-gray-700">Home usage kWh</span><select id="mapUse" class="input"></select></label>
              <label class="block"><span class="text-sm text-gray-700">Solar production kWh</span><select id="mapSolar" class="input"></select></label>
              <label class="block"><span class="text-sm text-gray-700">Grid import kWh</span><select id="mapImp" class="input"></select></label>
              <label class="block"><span class="text-sm text-gray-700">Grid export kWh</span><select id="mapExp" class="input"></select></label>
            </div>
            <div class="flex gap-2">
              <button id="detectBtn" type="button" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">Auto-detect</button>
              <button id="saveMapBtn" type="button" class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm">Save mapping</button>
              <button id="clearMapBtn" type="button" class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm">Clear mapping</button>
            </div>
            <p id="mapWarn" class="hidden mt-1 p-3 rounded-lg warn text-sm">One or more required columns were not found. Select Date and Home usage, then refresh.</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="font-semibold mb-2">Filters</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
          <label class="block"><span class="text-sm text-gray-700">Start date</span><input id="startDate" type="date" class="input" value="2025-06-01" /></label>
          <label class="block"><span class="text-sm text-gray-700">End date</span><input id="endDate" type="date" class="input" value="2025-12-31" /></label>
          <label class="block"><span class="text-sm text-gray-700">Import rate $/kWh</span><input id="importRate" type="number" step="0.0001" class="input" value="0.35" /></label>
          <label class="block"><span class="text-sm text-gray-700">Export credit $/kWh</span><input id="exportRate" type="number" step="0.0001" class="input" value="0.05" /></label>
          <div class="flex gap-2">
            <button id="applyBtn" type="button" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm w-full">Apply</button>
            <button id="clearBtn" type="button" class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm w-full">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between"><h2 class="font-semibold">Diagnostics</h2><button id="runTestsBtn" type="button" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white text-sm">Run tests</button></div>
        <div id="diagSettings" class="text-sm space-y-2 mt-2"></div>
        <div class="mt-2 text-sm"><span id="testSummary" class="text-sm"></span></div>
        <div id="testOutput" class="mt-2 text-sm mono"></div>
      </div>
    </section>
  </main>

  <!-- Bottom nav with center FAB -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200" style="padding-bottom: var(--safe-bottom);">
    <div class="grid grid-cols-5 items-center">
      <button class="py-2 tab-icon tab-active" data-tab="kpi">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        KPIs
      </button>
      <button class="py-2 tab-icon" data-tab="charts">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M19 9l-5 5-4-4-3 3"/></svg>
        Charts
      </button>
      <div class="flex justify-center">
        <button class="tab-fab" data-tab="entry">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
      <button class="py-2 tab-icon" data-tab="data">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        Data
      </button>
      <button class="py-2 tab-icon" data-tab="settings">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.28 1.35.76 1.82.48.47 1.13.76 1.82.76H21a2 2 0 0 1 0 4h-.09c-.69 0-1.35.28-1.82.76-.48.47-.76 1.13-.76 1.82z"/></svg>
        Settings
      </button>
    </div>
  </nav>

  <script>
    // ===== Tabs =====
    const tabs = document.querySelectorAll('nav [data-tab]');
    const sections = {
      kpi: document.getElementById('sec-kpi'),
      charts: document.getElementById('sec-charts'),
      data: document.getElementById('sec-data'),
      entry: document.getElementById('sec-entry'),
      settings: document.getElementById('sec-settings'),
    };
    function showTab(key){
      Object.entries(sections).forEach(([k,el])=> el.classList.toggle('hidden', k!==key));
      tabs.forEach(b=> b.classList.toggle('tab-active', b.dataset.tab===key));
    }
    tabs.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
    document.querySelector('.tab-fab')?.addEventListener('click', ()=> showTab('entry'));

    // ===== Diagnostics =====
    const diag = (msg) => { const d = document.getElementById('diag'); if(!d) return; d.textContent += (msg + "\n"); };
    const diagSettings = (msg) => { const d = document.getElementById('diagSettings'); if(!d) return; const p = document.createElement('p'); p.textContent = msg; d.appendChild(p); };
    window.addEventListener('error', (e) => { diag('JS error: ' + e.message); diagSettings('JS error: ' + e.message); });
    window.addEventListener('unhandledrejection', (e) => { const t = (e.reason && (e.reason.message || e.reason)); diag('Promise rejection: ' + t); diagSettings('Promise rejection: ' + t); });

    // ===== Formatting and mapping =====
    const fmtKWh = n => `${(Number.isFinite(n)?n:0).toLocaleString(undefined,{maximumFractionDigits:2})} kWh`;
    const fmtPct = n => `${((Number.isFinite(n)?n:0)*100).toFixed(1)}%`;
    const fmtUSD = n => (Number.isFinite(n)?n:0).toLocaleString(undefined,{style:'currency',currency:'USD'});
    const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim();

    const aliasMap = {
      date:['date','day','timestamp','readingdate','reading'],
      use:['homekwh','usage','usagekwh','home','load','consumption','energyuse','housekwh','totalconsumption','kwhused','usekwh','consumed'],
      solar:['solarkwh','solar','pv','pvkwh','production','generation','generated','energyproduced','solargeneration'],
      imp:['gridimportkwh','import','fromgrid','gridin','importkwh','gridpurchase','purchased','gridusage','gridconsumption','pulledfromgrid'],
      exp:['gridexportkwh','export','togrid','gridout','exportkwh','backtogrid','feedin','excess','exported']
    };

    function buildGvizUrl(id,sheet){
      const base = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq`;
      const params = new URLSearchParams(sheet?{sheet}:{})
      return `${base}?${params.toString()}`;
    }

    function sanitizeAntiXSSI(text){
      return text.replace(/^\)\]\}'\n/, '').replace(/^\/\*O_o\*\/\n/, '');
    }
    function parseGviz(text){
      const raw = sanitizeAntiXSSI(text);
      const m = raw.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s);
      if (!m) throw new Error('Unexpected GViz format');
      return JSON.parse(m[1]);
    }

    function parseDateCell(dCell){
      if (!dCell) return null;
      const v = dCell.v; const f = dCell.f;
      if (typeof v === 'string' && /^Date\(/.test(v)){
        const m = v.match(/^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
        if (m){ const [_, Y, M, D, h='0', mnt='0', s='0'] = m; const dt = new Date(Number(Y), Number(M), Number(D), Number(h), Number(mnt), Number(s)); if (!isNaN(dt)) return dt; }
      }
      if (typeof f === 'string'){ const dt = new Date(f); if (!isNaN(dt)) return dt; }
      if (v && typeof v === 'object' && v.year != null){ const dt = new Date(v.year, v.month || 0, v.day || 1); if (!isNaN(dt)) return dt; }
      if (typeof v === 'number'){
        if (v > 20000 && v < 60000){ const epoch = new Date(Date.UTC(1899,11,30)); const ms = v * 86400000; const dt = new Date(epoch.getTime() + ms); if (!isNaN(dt)) return dt; }
        else { const dt = new Date(v); if (!isNaN(dt)) return dt; }
      }
      if (typeof v === 'string'){ const dt = new Date(v); if (!isNaN(dt)) return dt; }
      return null;
    }

    function populateMappingSelects(cols){
      const selects = [['mapDate','date'],['mapUse','use'],['mapSolar','solar'],['mapImp','imp'],['mapExp','exp']];
      selects.forEach(([id]) => {
        const sel = document.getElementById(id);
        sel.innerHTML='';
        cols.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=c; sel.appendChild(o); });
        if (id==='mapImp' || id==='mapExp' || id==='mapSolar'){
          const none=document.createElement('option'); none.value=''; none.textContent='None'; sel.insertBefore(none, sel.firstChild);
        }
      });
    }

    function tryAutoMap(cols){
      const ncols = cols.map(norm);
      function pick(key){
        for (const alias of aliasMap[key]){ const i=ncols.findIndex(c=>c===alias); if(i!==-1) return i; }
        for (const alias of aliasMap[key]){ const i=ncols.findIndex(c=>c.includes(alias)); if(i!==-1) return i; }
        const tokens = aliasMap[key];
        const scored = ncols.map((c,i)=>({i,score:tokens.reduce((a,t)=>a+(c.includes(t)?1:0),0)})).sort((a,b)=>b.score-a.score);
        if (scored[0] && scored[0].score>0) return scored[0].i;
        return null;
      }
      return { date:pick('date'), use:pick('use'), solar:pick('solar'), imp:pick('imp'), exp:pick('exp') };
    }

    function saveMapping(id,sheet,map){ localStorage.setItem(`energy-map:${id}:${sheet}`, JSON.stringify(map)); }
    function loadMapping(id,sheet){ const raw=localStorage.getItem(`energy-map:${id}:${sheet}`); return raw?JSON.parse(raw):null; }
    function setSelectValues(map){ if(!map) return; const pairs=[["mapDate","date"],["mapUse","use"],["mapSolar","solar"],["mapImp","imp"],["mapExp","exp"]];
      for(const [selId,key] of pairs){ const sel=document.getElementById(selId); if(!sel) continue; const v=map[key]; if (v==null) continue; if(Number.isInteger(v)&&v>=0&&v<sel.options.length) sel.value=String(v);} }
    function getCurrentMapping(){ const v=id=>{const x=document.getElementById(id).value; return x===''?null:Number(x)}; return { date:v('mapDate'), use:v('mapUse'), solar:v('mapSolar'), imp:v('mapImp'), exp:v('mapExp') }; }
    function mappingIsValid(map){ return Number.isInteger(map.date) && Number.isInteger(map.use); }

    function extractRowsByIndex(gviz, idx){
      const rows = (gviz.table.rows||[]).filter(r=>r.c).map(r=>{
        const date = parseDateCell(r.c[idx.date]); if (!date) return null;
        const getNum = i => (i==null || !r.c[i] || r.c[i].v==null || r.c[i].v==='') ? 0 : Number(r.c[i].v);
        const use=getNum(idx.use); const solar=idx.solar!=null?getNum(idx.solar):0; const imp=idx.imp!=null?getNum(idx.imp):0; const exp=idx.exp!=null?getNum(idx.exp):0;
        const solarToLoad = Math.max(0, Math.min(solar, Math.max(0, use - imp)));
        return { date, use, solar, imp, exp, solarToLoad };
      }).filter(Boolean).sort((a,b)=>a.date-b.date);
      return rows;
    }

    function calcKPIs(rows){
      if(!rows.length) return { totalUse:0,totalSolar:0,totalImp:0,totalExp:0,selfConsumption:0,selfSufficiency:0,avgDailyUse:0,savings:0 };
      const sum=k=>rows.reduce((a,b)=>a+(b[k]||0),0);
      const totalUse=sum('use'); const totalSolar=sum('solar'); const totalImp=sum('imp'); const totalExp=sum('exp');
      const solarToLoad = Math.min(totalSolar, Math.max(0, totalUse - totalImp));
      const selfConsumption = totalSolar ? solarToLoad/totalSolar : 0;
      const selfSufficiency = totalUse ? solarToLoad/totalUse : 0;
      const days = (rows[rows.length-1].date - rows[0].date)/86400000 + 1; const avgDailyUse = days>0 ? totalUse/days : 0;
      const importRate = Number(document.getElementById('importRate').value)||0;
      const exportRate = Number(document.getElementById('exportRate').value)||0;
      const costNoSolar = totalUse * importRate; const costWithSolar = totalImp * importRate - totalExp * exportRate;
      const savings = Math.max(0, costNoSolar - costWithSolar);
      return { totalUse,totalSolar,totalImp,totalExp,selfConsumption,selfSufficiency,avgDailyUse,savings };
    }

    function renderKPIs(k){
      document.getElementById('kpiUsage').textContent = fmtKWh(k.totalUse);
      document.getElementById('kpiSolar').textContent = fmtKWh(k.totalSolar);
      document.getElementById('kpiImport').textContent = fmtKWh(k.totalImp);
      document.getElementById('kpiExport').textContent = fmtKWh(k.totalExp);
      document.getElementById('kpiSelfConsumption').textContent = fmtPct(k.selfConsumption);
      document.getElementById('kpiSelfSufficiency').textContent = fmtPct(k.selfSufficiency);
      document.getElementById('kpiAvgDailyUse').textContent = fmtKWh(k.avgDailyUse);
      document.getElementById('kpiSavings').textContent = fmtUSD(k.savings);
    }

    let monthlyChart;
    function renderCharts(rows){
      const monthMap = new Map();
      for (const r of rows){
        const key = r.date.getFullYear() + '-' + String(r.date.getMonth()+1).padStart(2,'0');
        const agg = monthMap.get(key) || { use:0, solar:0 };
        agg.use += (r.use||0); agg.solar += (r.solar||0);
        monthMap.set(key, agg);
      }
      const labels = Array.from(monthMap.keys()).sort();
      const use = labels.map(k => monthMap.get(k).use);
      const solar = labels.map(k => monthMap.get(k).solar);
      const ctx = document.getElementById('chartMonthly');
      if (!ctx) return;
      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [
          { label: 'Usage kWh', data: use },
          { label: 'Solar kWh', data: solar }
        ]},
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function renderTable(rows){
      const tbody = document.getElementById('tableBody'); if(!tbody) return; tbody.innerHTML=''; const frag=document.createDocumentFragment();
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `
        <td class=\"p-2 whitespace-nowrap\">${r.date.toISOString().split('T')[0]}</td>
        <td class=\"p-2 text-right\">${r.use.toFixed(2)}</td>
        <td class=\"p-2 text-right\">${r.solar.toFixed(2)}</td>
        <td class=\"p-2 text-right\">${r.imp.toFixed(2)}</td>
        <td class=\"p-2 text-right\">${r.exp.toFixed(2)}</td>
        <td class=\"p-2 text-right\">${r.solarToLoad.toFixed(2)}</td>`; frag.appendChild(tr); });
      tbody.appendChild(frag);
    }

    function renderAll(rows){ renderKPIs(calcKPIs(rows)); renderCharts(rows); renderTable(rows); }
    function showWarn(show,msg){ const el=document.getElementById('mapWarn'); if(!el) return; if(show){ el.classList.remove('hidden'); if(msg) el.textContent=msg; } else { el.classList.add('hidden'); } }

    // ===== OAuth and data fetch =====
    const GOOGLE_CLIENT_ID = "656801194507-ujbqhlcm5ou4nqfq25c5j657jl6gnkoo.apps.googleusercontent.com";
    const SHEETS_SCOPE = "https://www.googleapis.com/auth/spreadsheets";
    let accessToken = null; let tokenClient = null; let tokenExpiresAt = 0;

    function valuesToGviz(values){
      if (!values || !values.length) { return { table: { cols: [], rows: [] } }; }
      const headers = values[0]; const body = values.slice(1);
      return { table: { cols: headers.map(h => ({ label: String(h || '').trim() })), rows: body.map(r => ({ c: headers.map((_, i) => ({ v: r[i] !== undefined ? r[i] : '' })) })) } };
    }

    async function fetchSheetValues(spreadsheetId, sheetName){
      const now = Date.now(); if (accessToken && now > tokenExpiresAt - 10000) { try { tokenClient.requestAccessToken({ prompt: '' }); } catch(_){} }
      const range = encodeURIComponent(`${sheetName}!A1:Z10000`);
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?majorDimension=ROWS`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
      if (!res.ok) { const t = await res.text(); throw new Error(`Sheets API error ${res.status}: ${t}`); }
      return res.json();
    }

    function cacheRows(id, name, rows){
      try { const key = `rows-cache:${id}:${name}`; const flat = rows.map(r=>({d:r.date.toISOString(),u:r.use,s:r.solar,i:r.imp,e:r.exp,l:r.solarToLoad})); localStorage.setItem(key, JSON.stringify(flat)); }
      catch(_){}
    }
    function loadCachedRows(id, name){
      try { const key = `rows-cache:${id}:${name}`; const raw = localStorage.getItem(key); if(!raw) return null; const flat = JSON.parse(raw); return flat.map(x=>({date:new Date(x.d), use:+x.u, solar:+x.s, imp:+x.i, exp:+x.e, solarToLoad:+x.l})); }
      catch(_) { return null; }
    }

    async function loadDataPrivate(){
      const id=document.getElementById('sheetId').value.trim(); const name=document.getElementById('sheetName').value.trim();
      document.getElementById('sheetLink').href = `https://docs.google.com/spreadsheets/d/${id}/edit`;
      try {
        const j = await fetchSheetValues(id, name); const g = valuesToGviz(j.values||[]);
        const cols = (g.table&&g.table.cols?g.table.cols:[]).map(c=>(c.label||'').trim());
        populateMappingSelects(cols);
        const stored = loadMapping(id,name); const auto = tryAutoMap(cols); const map = stored || auto || { date: 0 };
        setSelectValues(map);
        if (!stored && (!auto || auto.date == null)){ const sel = document.getElementById('mapDate'); if (sel && sel.options.length){ sel.value = '0'; } }
        if (!mappingIsValid(getCurrentMapping())){ showWarn(true,'Select Date and Home usage, then refresh.'); return; }
        showWarn(false);
        const rows = extractRowsByIndex(g, getCurrentMapping()); window.__rows = rows; cacheRows(id,name,rows);
        applyFilters(); diag(`Loaded ${rows.length} rows via Sheets API (private).`);
      } catch(e){
        diag('Private load failed: ' + e.message);
        const cached = loadCachedRows(id,name);
        if (cached){ window.__rows=cached; applyFilters(); diag(`Loaded ${cached.length} rows from cache.`); }
        else { alert(`Private load failed: ${e.message}`); }
      }
    }

    async function loadData(){
      if (accessToken) { await loadDataPrivate(); return; }
      const id=document.getElementById('sheetId').value.trim(); const name=document.getElementById('sheetName').value.trim();
      const url = buildGvizUrl(id, name);
      document.getElementById('sheetLink').href = `https://docs.google.com/spreadsheets/d/${id}/edit`;
      try {
        const res=await fetch(url); const txt=await res.text(); const g=parseGviz(txt);
        const cols=g.table.cols.map(c=>c.label||c.id); populateMappingSelects(cols);
        const stored = loadMapping(id,name); const auto = tryAutoMap(cols); const map = stored || auto || { date: 0 };
        setSelectValues(map);
        if (!stored && (!auto || auto.date == null)){ const sel = document.getElementById('mapDate'); if (sel && sel.options.length){ sel.value = '0'; } }
        if (!mappingIsValid(getCurrentMapping())){ showWarn(true,'Select Date and Home usage, then refresh.'); return; }
        showWarn(false);
        const rows=extractRowsByIndex(g, getCurrentMapping());
        window.__rows=rows; cacheRows(id,name,rows); applyFilters();
        diag(`Loaded ${rows.length} rows. Columns detected: ${cols.join(', ')}`);
      } catch(e){
        diag('Public load failed: ' + e.message);
        const cached = loadCachedRows(id,name);
        if (cached){ window.__rows=cached; applyFilters(); diag(`Loaded ${cached.length} rows from cache.`); }
        else { alert(`Failed to load data: ${e.message}`); }
      }
    }

    function applyFilters(){
      const s=document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
      const e=document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;
      const rows=(window.__rows||[]).filter(r=>(!s||r.date>=s)&&(!e||r.date<=e));
      renderAll(rows);
    }

    // ===== Entry helpers and write flow =====
    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const d=$('diag'); if(d) d.textContent += m + "\n"; };
    function todayLocalYMD(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function toNumber(v){ if (v == null) return NaN; if (typeof v === 'number') return v; if (typeof v === 'string'){ let s = v.trim(); if (!s) return NaN; s = s.replace(/[, ]+/g,'').replace(/[^0-9.+-Ee]/g,''); const n = Number(s); return Number.isFinite(n) ? n : NaN; } return NaN; }
    function parseISOYMD(s){ const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||'').trim()); return m ? { y:+m[1], m:+m[2], d:+m[3] } : null; }
    function parseMDY(s){ const m = /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(String(s||'').trim()); return m ? { y:+m[3], m:+m[1], d:+m[2] } : null; }
    function parseCellDateToParts(v){ if (typeof v === 'string'){ return parseISOYMD(v) || parseMDY(v); } return null; }
    function ymdToString(p){ return `${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`; }
    function addDaysParts(p, n){ const dt = new Date(Date.UTC(p.y, p.m-1, p.d)); dt.setUTCDate(dt.getUTCDate() + n); return { y: dt.getUTCFullYear(), m: dt.getUTCMonth()+1, d: dt.getUTCDate() }; }
    function daysBetweenParts(a, b){ const au = Date.UTC(a.y, a.m-1, a.d); const bu = Date.UTC(b.y, b.m-1, b.d); return Math.round((bu - au) / 86400000); }

    async function sheetsGet(rangeA1){
      const id = $('sheetId').value.trim();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1)}?majorDimension=ROWS`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
      if (!res.ok) throw new Error(`Sheets GET ${res.status}: ${await res.text()}`);
      const j = await res.json();
      return j.values || [];
    }
    async function sheetsAppend(rangeA1ColsOnly, values2d){
      const id = $('sheetId').value.trim();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1ColsOnly)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
      const res = await fetch(url, { method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ majorDimension: 'ROWS', values: values2d }) });
      if (!res.ok) throw new Error(`Sheets APPEND ${res.status}: ${await res.text()}`);
      return res.json();
    }

    function findLastRowByA(values){
      if (!values || values.length < 2) return { headers: values?.[0]||[], row: null, index: 0 };
      const headers = values[0];
      for (let i = values.length - 1; i >= 1; i--){ const row = values[i] || []; const a = row[0]; if (a != null && String(a).trim() !== '') return { headers, row, index: i }; }
      return { headers, row: null, index: 0 };
    }

    function buildExtrapolatedRows(valuesABC, inputDateStr, inputITD, inputProd){
      const last = findLastRowByA(valuesABC);
      if (!last.row) throw new Error('No last row found. Ensure there is a header row and at least one data row.');
      const lastITD = toNumber(last.row[1]); if (!Number.isFinite(lastITD)) throw new Error('Last ITD missing or not numeric in Column B.');
      const lastParts = parseCellDateToParts(last.row[0]); if (!lastParts) throw new Error('Could not parse last date. Ensure Column A is a recognizable date.');
      const inputParts = parseISOYMD(inputDateStr); if (!inputParts) throw new Error('Input date must be YYYY-MM-DD.');
      const gapDays = daysBetweenParts(lastParts, inputParts); if (gapDays < 1) throw new Error('Input date must be after the last recorded date.');
      if (gapDays === 1){ return [[ ymdToString(inputParts), Number(inputITD), Number(inputProd) ]]; }
      const missingCount = gapDays - 1;
      const deltaITD = Number(inputITD) - lastITD;
      const missingSum = deltaITD - Number(inputProd);
      if (!Number.isFinite(deltaITD) || !Number.isFinite(missingSum)) throw new Error('Input ITD or Prod is not a valid number.');
      if (missingSum < -1e-9) throw new Error('Numbers inconsistent: input ITD is less than last ITD plus input Prod.');
      const even = missingCount > 0 ? missingSum / missingCount : 0;
      const rows = []; let runningITD = lastITD; let allocated = 0;
      for (let i = 1; i <= missingCount; i++){
        let prod = i < missingCount ? even : (missingSum - allocated);
        if (Math.abs(prod) < 1e-12) prod = 0;
        runningITD += prod; const parts = addDaysParts(lastParts, i);
        rows.push([ ymdToString(parts), Number(runningITD), Number(prod) ]);
        allocated += prod;
      }
      rows.push([ ymdToString(inputParts), Number(inputITD), Number(inputProd) ]);
      return rows;
    }

    function renderLast(headers, row, index){
      const thead = document.getElementById('lastHead');
      const tbody = document.getElementById('lastBody');
      thead.innerHTML = ''; tbody.innerHTML = '';
      headers.forEach(h => { const th=document.createElement('th'); th.className='p-2 text-left'; th.textContent=String(h||''); thead.appendChild(th); });
      if (row){
        for (let c=0;c<headers.length;c++){
          const td=document.createElement('td'); td.className='p-2 whitespace-nowrap';
          const raw=row[c]; let v = raw == null ? '' : String(raw);
          const parts = c===0 ? parseCellDateToParts(v) : null; if (parts) v = ymdToString(parts);
          td.textContent = v; tbody.appendChild(td);
        }
        document.getElementById('rowMeta').textContent = `Last data row index by Column A: ${index}`;
      } else {
        const td = document.createElement('td'); td.className='p-2 text-sm text-gray-500'; td.colSpan=headers.length||1; td.textContent='No data rows yet'; tbody.appendChild(td);
        document.getElementById('rowMeta').textContent = '';
      }
    }

    async function loadLast(){
      const name = document.getElementById('entrySheetName').value.trim();
      const id = document.getElementById('sheetId').value.trim();
      const link = document.getElementById('sheetLink'); if (link) link.href = `https://docs.google.com/spreadsheets/d/${id}/edit#gid=0`;
      try{ const values = await sheetsGet(`${name}!A1:C10000`); const r = findLastRowByA(values); renderLast(r.headers, r.row, r.index); log(`Loaded ${Math.max(0,(values||[]).length-1)} rows.`); }
      catch(e){ log('Load failed: ' + e.message); alert('Load failed: ' + e.message); }
    }

    async function appendRow(){
      const name = document.getElementById('entrySheetName').value.trim();
      const inputDateStr = document.getElementById('inDate').value.trim();
      const inputITD = toNumber(document.getElementById('inITD').value.trim());
      const inputProd = toNumber(document.getElementById('inProd').value.trim());
      const status = document.getElementById('status');
      if (!inputDateStr || !Number.isFinite(inputITD) || !Number.isFinite(inputProd)){
        status.textContent = 'Enter a valid Date, ITD, and Prod'; status.className='text-sm bad'; return;
      }
      status.textContent = 'Calculating and writing...'; status.className='text-sm';
      try{
        const valuesABC = await sheetsGet(`${name}!A1:C10000`);
        const rowsToWrite = buildExtrapolatedRows(valuesABC, inputDateStr, inputITD, inputProd);
        await sheetsAppend(`${name}!A:C`, rowsToWrite);
        status.textContent = `Saved ${rowsToWrite.length} row(s)`; status.className='text-sm ok';
        document.getElementById('inDate').value = todayLocalYMD();
        document.getElementById('inITD').value=''; document.getElementById('inProd').value='';
        await loadLast();
      } catch(e){ status.textContent = 'Append failed: ' + e.message; status.className='text-sm bad'; log('Append failed: ' + e.message); }
    }

    // ===== Install prompt =====
    let deferredPrompt = null;
    const banner = document.getElementById('installBanner');
    const installBtn = document.getElementById('installBtn');
    const dismissInstall = document.getElementById('dismissInstall');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; banner.classList.remove('hidden'); });
    if (dismissInstall) dismissInstall.addEventListener('click', ()=> banner.classList.add('hidden'));
    if (installBtn) installBtn.addEventListener('click', async ()=>{ if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; banner.classList.add('hidden'); deferredPrompt = null; });

    // ===== OAuth init =====
    function initGsi(){
      if (!(window.google && google.accounts && google.accounts.oauth2)) return false;
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SHEETS_SCOPE,
        callback: (resp) => {
          if (resp && resp.access_token){
            accessToken = resp.access_token; tokenExpiresAt = Date.now() + 55*60*1000;
            setAuthUI(true); loadDataPrivate(); loadLast();
            const appendBtn = document.getElementById('appendBtn'); if (appendBtn) appendBtn.disabled = false;
          }
        }
      });
      return true;
    }
    function setAuthUI(signedIn){
      const inBtn=document.getElementById('signInBtn'); const outBtn=document.getElementById('signOutBtn');
      if (signedIn){ outBtn.classList.remove('hidden'); inBtn.classList.add('hidden'); }
      else { outBtn.classList.add('hidden'); inBtn.classList.remove('hidden'); }
    }

    // ===== Wire events =====
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs
     
