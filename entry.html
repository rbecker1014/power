<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry — Last Row + Append (Server endpoint)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 16px rgba(0,0,0,.06);padding:1rem}
    .input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem;width:100%}
    .ok{color:#065f46}.bad{color:#991b1b}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl font-bold">Data Entry</h1>
      <nav class="flex items-center gap-2 text-sm">
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="index.html">Dashboard</a>
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="data.html">All Rows</a>
      </nav>
    </header>

    <!-- Connection -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Connection</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Google Sheet ID</span>
          <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Sheet name</span>
          <input id="sheetName" class="input" value="Data" />
        </label>
        <label class="block sm:col-span-2">
          <span class="text-sm text-gray-700">Append endpoint URL</span>
          <input id="appendUrl" class="input" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Shared secret</span>
          <input id="appendSecret" class="input" placeholder="optional but recommended" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="saveCfg" class="px-3 py-2 rounded-lg bg-gray-900 text-white">Save</button>
        <button id="pingBtn" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">Ping</button>
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <a id="sheetLink" href="#" target="_blank" class="px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="cfgStatus" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Tip: you can also open with <code>?append=URL&secret=XYZ</code> to auto-save settings.</p>
    </section>

    <!-- Last row -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row where Column A has a value</h2>
      <div class="overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm" id="lastTable">
          <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
          <tbody><tr id="lastBody"></tr></tbody>
        </table>
      </div>
      <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
    </section>

    <!-- Append form -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Append a new row</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block"><span class="text-sm text-gray-700">Date (A)</span><input id="inDate" type="date" class="input" /></label>
        <label class="block"><span class="text-sm text-gray-700">ITD Production (B)</span><input id="inITD" type="number" step="any" class="input" placeholder="12345" /></label>
        <label class="block"><span class="text-sm text-gray-700">Daily Production (C)</span><input id="inProd" type="number" step="any" class="input" placeholder="kWh" /></label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Append Row</button>
        <span id="status" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Writes to the first row with Column A empty. Server endpoint performs the write.</p>
    </section>

    <!-- Diagnostics -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <pre id="diag" class="mono text-xs whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script>
  'use strict';

  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const log = (m)=>{ const d=$('diag'); d.textContent += m + "\\n"; };

  // ===== Shared storage keys (same as before) =====
  const ENDPOINT_KEYS = ['data:endpoint','append:endpoint','api:endpoint','backend:endpoint'];
  const SECRET_KEYS   = ['data:secret','append:secret','api:secret','backend:secret'];
  const readShared = (keys)=>{ for(const k of keys){ const v=localStorage.getItem(k); if(v) return v; } return ''; };
  const writeShared = (keys,v)=>{ keys.forEach(k=> v? localStorage.setItem(k,v): localStorage.removeItem(k)); };

  // ===== GViz public read =====
  function sanitizeAntiXSSI(t){ return t.replace(/^\\)\\]\\}'\\n/, '').replace(/^\\/\\*O_o\\*\\/\\n/, ''); }
  function parseGviz(text){
    const raw = sanitizeAntiXSSI(text);
    const m = raw.match(/google\\.visualization\\.Query\\.setResponse\\((.*)\\);?/s);
    if (!m) throw new Error('Unexpected GViz format');
    return JSON.parse(m[1]);
  }
  function gvizToValues(g){
    const cols = (g.table && g.table.cols ? g.table.cols : []).map(c => (c.label || c.id || '').trim());
    const rows = (g.table && g.table.rows ? g.table.rows : []).map(r => (r.c||[]).map(c => c && c.v!=null ? c.v : ''));
    return [cols, ...rows];
  }
  function buildGvizUrl(id, sheet){ const p=new URLSearchParams(sheet?{sheet}:{}) ; return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?${p.toString()}`; }

  function hasValue(v){ return !(v==null || (typeof v==='string' && v.trim()==='')); }
  function excelSerialToDate(n){ const ms=(Number(n)-25569)*86400000; const d=new Date(ms); return isNaN(d)?null:d; }
  function parseMaybeDate(v){
    if(typeof v==='string'){
      const m=v.match(/^Date\\((\\d+),\\s*(\\d+),\\s*(\\d+)/);
      if(m){ const d=new Date(+m[1],+m[2],+m[3]); if(!isNaN(d)) return d; }
      const d1=new Date(v); if(!isNaN(d1)) return d1;
    }
    if(v && typeof v==='object' && v.year!=null){ const d2=new Date(v.year, v.month||0, v.day||1); if(!isNaN(d2)) return d2; }
    if(typeof v==='number'){ return excelSerialToDate(v); }
    return null;
  }
  function fmtDateCell(v){ const d=parseMaybeDate(v); return d? d.toISOString().slice(0,10) : (v==null? '': String(v)); }

  function findLastRowByColA(values){
    if(!values || values.length<2) return { headers: values?.[0]||[], row:null, index:0 };
    const headers=values[0];
    for(let i=values.length-1;i>=1;i--){
      const row=values[i]||[];
      if(hasValue(row[0])) return { headers,row,index:i };
    }
    return { headers,row:null,index:0 };
  }
  function renderLast(headers,row,index){
    const thead = $('lastHead'); const tbody = $('lastBody');
    thead.innerHTML=''; tbody.innerHTML='';
    headers.forEach(h=>{ const th=document.createElement('th'); th.className='p-2 text-left'; th.textContent=String(h||''); thead.appendChild(th); });
    if(row){
      for(let c=0;c<headers.length;c++){
        const td=document.createElement('td'); td.className='p-2 whitespace-nowrap';
        const raw=row[c]; const v=(c===0)?fmtDateCell(raw):(raw==null?'':(typeof raw==='object'?JSON.stringify(raw):String(raw)));
        td.textContent=v; tbody.appendChild(td);
      }
      $('rowMeta').textContent = `Last data row index (by Column A): ${index}`;
    } else {
      const td=document.createElement('td'); td.className='p-2 text-sm text-gray-500'; td.colSpan=headers.length||1; td.textContent='No rows yet'; tbody.appendChild(td);
      $('rowMeta').textContent='';
    }
  }

  async function loadLast(){
    const id=$('sheetId').value.trim(); const name=$('sheetName').value.trim();
    $('sheetLink').href=`https://docs.google.com/spreadsheets/d/${id}/edit#gid=0`;
    try{
      const res=await fetch(buildGvizUrl(id,name));
      const txt=await res.text();
      const g=parseGviz(txt);
      const values=gvizToValues(g);
      const {headers,row,index}=findLastRowByColA(values);
      renderLast(headers,row,index);
      log(`Loaded ${Math.max(0,(values||[]).length-1)} rows.`);
    }catch(e){
      log('Load failed: '+e.message);
      alert('Load failed: '+e.message);
      console.error(e);
    }
  }

  // ===== Append via server endpoint (same approach that worked before) =====
  function getEndpoint(){ return readShared(ENDPOINT_KEYS) || $('appendUrl').value.trim(); }
  function getSecret(){ return readShared(SECRET_KEYS) || $('appendSecret').value.trim(); }

  async function pingEndpoint(){
    const ep = getEndpoint();
    if(!ep){ $('cfgStatus').textContent='No endpoint set'; return; }
    $('cfgStatus').textContent='Pinging…';
    try{
      const res = await fetch(ep + (ep.includes('?')?'&':'?') + 'ping=1', { method:'GET', mode:'cors', credentials:'omit' });
      $('cfgStatus').textContent = res.ok ? 'Endpoint reachable' : `Ping failed ${res.status}`;
    } catch(e){
      $('cfgStatus').textContent = 'Ping error: ' + e.message;
    }
    setTimeout(()=> $('cfgStatus').textContent='', 2200);
  }

  async function appendViaServer(row){
    const endpoint = getEndpoint();
    if(!endpoint) throw new Error('No append endpoint configured.');
    const payload = {
      spreadsheetId: $('sheetId').value.trim(),
      sheetName: $('sheetName').value.trim(),
      row,
      secret: getSecret(),
      op: 'appendAtFirstEmptyA'
    };

    // Use a simple POST without Content-Type to avoid preflight (matches what worked for you before).
    let res, text;
    try{
      res = await fetch(endpoint, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify(payload)
      });
    } catch(err){
      throw new Error('Network or CORS error: ' + err.message);
    }

    try { text = await res.text(); } catch { text = ''; }
    let data = null; try { data = text ? JSON.parse(text) : null; } catch {}
    if(!res.ok){ throw new Error(`Server append failed ${res.status}. Body: ${text || '[no body]'}`); }
    return data || { ok:true };
  }

  async function handleAppend(){
    const date=$('inDate').value.trim();
    const itd=$('inITD').value.trim();
    const prod=$('inProd').value.trim();
    const status=$('status');
    if(!date || itd==='' || prod===''){ status.textContent='Fill all three fields'; status.className='text-sm bad'; return; }
    if(!getEndpoint()){ status.textContent='Set your endpoint in Connection and click Save'; status.className='text-sm bad'; return; }

    status.textContent='Appending…'; status.className='text-sm';
    try{
      const row=[date, Number(itd), Number(prod)];
      await appendViaServer(row);
      status.textContent='Saved'; status.className='text-sm ok';
      $('inDate').value=todayISO(); $('inITD').value=''; $('inProd').value='';
      await loadLast();
    } catch(e){
      status.textContent='Append failed: ' + e.message; status.className='text-sm bad';
      log('Append failed: ' + e.message);
    }
  }

  // ===== Config save/load =====
  function loadCfgUI(){
    $('appendUrl').value = readShared(ENDPOINT_KEYS);
    $('appendSecret').value = readShared(SECRET_KEYS);
  }
  function saveCfg(){
    writeShared(ENDPOINT_KEYS, $('appendUrl').value.trim());
    writeShared(SECRET_KEYS, $('appendSecret').value.trim());
    $('cfgStatus').textContent='Saved';
    setTimeout(()=> $('cfgStatus').textContent='', 1200);
  }
  function hydrateFromQuery(){
    const q=new URLSearchParams(location.search);
    const ep=q.get('append'); const sec=q.get('secret');
    if(ep){ writeShared(ENDPOINT_KEYS, ep); $('appendUrl').value=ep; }
    if(sec){ writeShared(SECRET_KEYS, sec); $('appendSecret').value=sec; }
  }

  // ===== Wire up once DOM is ready =====
  window.addEventListener('DOMContentLoaded', ()=>{
    log('JS ready'); // confirms the script actually ran
    $('inDate').value = todayISO();
    $('sheetLink').href = `https://docs.google.com/spreadsheets/d/${$('sheetId').value.trim()}/edit#gid=0`;

    hydrateFromQuery();
    loadCfgUI();

    $('saveCfg').addEventListener('click', saveCfg);
    $('pingBtn').addEventListener('click', pingEndpoint);
    $('refreshBtn').addEventListener('click', loadLast);
    $('appendBtn').addEventListener('click', handleAppend);

    loadLast();
  });
  </script>
</body>
</html>
