<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry â€” Solar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer onload="window.__gisLoaded && window.__gisLoaded()"></script>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 16px rgba(0,0,0,.06);padding:1rem}
    .input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem;width:100%}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    .ok{color:#065f46}.bad{color:#991b1b}
    .chip{display:inline-block;border-radius:9999px;padding:.15rem .55rem;background:#f3f4f6;font-size:.75rem}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl font-bold">Data Entry</h1>
      <nav class="flex items-center gap-2 text-sm">
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="index.html">Dashboard</a>
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="data.html">All Rows</a>
        <button id="signInBtn" class="px-3 py-1 rounded bg-gray-900 text-white">Sign in</button>
        <span id="whoAmI" class="chip">Signed out</span>
      </nav>
    </header>

    <!-- Connection -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Connection</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Google Sheet ID</span>
          <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Sheet name</span>
          <input id="sheetName" class="input" value="Data" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <a id="sheetLink" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="modeChip" class="text-sm text-gray-600">Mode: Private (Sheets API)</span>
      </div>
    </section>

    <!-- Last row -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row where Column A is not blank</h2>
      <div class="overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
          <tbody><tr id="lastBody"></tr></tbody>
        </table>
      </div>
      <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
    </section>

    <!-- Append -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Append a new row</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block"><span class="text-sm text-gray-700">Date (A)</span><input id="inDate" type="date" class="input" /></label>
        <label class="block"><span class="text-sm text-gray-700">ITD Production (B)</span><input id="inITD" type="number" step="any" class="input" placeholder="12345" /></label>
        <label class="block"><span class="text-sm text-gray-700">Daily Production (C)</span><input id="inProd" type="number" step="any" class="input" placeholder="kWh" /></label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700" disabled>Append Row</button>
        <span id="status" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">If your date skips days, missing dates are auto-filled with extrapolated ITD and Prod so the cumulative matches your input ITD.</p>
    </section>

    <!-- Diagnostics -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <pre id="diag" class="mono text-xs whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script>
  'use strict';

  // OAuth
  const GOOGLE_CLIENT_ID = "656801194507-ujbqhlcm5ou4nqfq25c5j657jl6gnkoo.apps.googleusercontent.com";
  const SHEETS_SCOPE = "https://www.googleapis.com/auth/spreadsheets";
  let accessToken = null;
  let tokenClient = null;

  // DOM helpers
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const d=$('diag'); d.textContent += m + "\n"; };
  function todayLocalYMD(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  // Numbers
  function toNumber(v){
    if (v == null) return NaN;
    if (typeof v === 'number') return v;
    if (typeof v === 'string'){
      let s = v.trim();
      if (!s) return NaN;
      s = s.replace(/[, ]+/g,'').replace(/[^0-9.+-Ee]/g,'');
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }
    return NaN;
  }

  // Date parsing - all LOCAL calendar math without new Date('YYYY-MM-DD')
  function parseISOYMD(s){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||'').trim());
    return m ? { y:+m[1], m:+m[2], d:+m[3] } : null;
  }
  function parseMDY(s){
    const m = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/.exec(String(s||'').trim());
    return m ? { y:+m[3], m:+m[1], d:+m[2] } : null;
  }
  function parseCellDateToParts(v){
    if (typeof v === 'string'){
      return parseISOYMD(v) || parseMDY(v);
    }
    return null;
  }
  function ymdToString(p){ return `${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`; }
  function addDaysParts(p, n){
    const dt = new Date(Date.UTC(p.y, p.m-1, p.d));
    dt.setUTCDate(dt.getUTCDate() + n);
    return { y: dt.getUTCFullYear(), m: dt.getUTCMonth()+1, d: dt.getUTCDate() };
  }
  function daysBetweenParts(a, b){ // b - a in days
    const au = Date.UTC(a.y, a.m-1, a.d);
    const bu = Date.UTC(b.y, b.m-1, b.d);
    return Math.round((bu - au) / 86400000);
  }

  // Sheets API
  async function sheetsGet(rangeA1){
    const id = $('sheetId').value.trim();
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1)}?majorDimension=ROWS`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error(`Sheets GET ${res.status}: ${await res.text()}`);
    const j = await res.json();
    return j.values || [];
  }
  async function sheetsAppend(rangeA1ColsOnly, values2d){
    const id = $('sheetId').value.trim();
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1ColsOnly)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
    const res = await fetch(url, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ majorDimension: 'ROWS', values: values2d })
    });
    if (!res.ok) throw new Error(`Sheets APPEND ${res.status}: ${await res.text()}`);
    return res.json();
  }

  // Find last non-empty A for display
  function findLastRowByA(values){
    if (!values || values.length < 2) return { headers: values?.[0]||[], row: null, index: 0 };
    const headers = values[0];
    for (let i = values.length - 1; i >= 1; i--){
      const row = values[i] || [];
      const a = row[0];
      if (a != null && String(a).trim() !== '') return { headers, row, index: i };
    }
    return { headers, row: null, index: 0 };
  }

  // Build rows for missing dates plus final input date
  function buildExtrapolatedRows(valuesABC, inputDateStr, inputITD, inputProd){
    const last = findLastRowByA(valuesABC);
    if (!last.row) throw new Error('No last row found. Ensure there is a header row and at least one data row.');

    const lastITD = toNumber(last.row[1]);
    if (!Number.isFinite(lastITD)) throw new Error('Last ITD missing or not numeric in Column B.');

    const lastParts = parseCellDateToParts(last.row[0]);
    if (!lastParts) throw new Error('Could not parse last date. Please ensure Column A is a recognizable date.');

    const inputParts = parseISOYMD(inputDateStr);
    if (!inputParts) throw new Error('Input date must be YYYY-MM-DD.');

    const gapDays = daysBetweenParts(lastParts, inputParts); // input - last
    if (gapDays < 1) throw new Error('Input date must be after the last recorded date.');

    // Exactly next day: one row
    if (gapDays === 1){
      return [[ ymdToString(inputParts), Number(inputITD), Number(inputProd) ]];
    }

    // Missing days exist
    const missingCount = gapDays - 1;
    const deltaITD = Number(inputITD) - lastITD;
    const missingSum = deltaITD - Number(inputProd);
    if (!Number.isFinite(deltaITD) || !Number.isFinite(missingSum)){
      throw new Error('Input ITD or Prod is not a valid number.');
    }
    if (missingSum < -1e-9){
      throw new Error('Numbers inconsistent: input ITD is less than last ITD plus input Prod.');
    }

    const even = missingCount > 0 ? missingSum / missingCount : 0;
    const rows = [];
    let runningITD = lastITD;
    let allocated = 0;

    for (let i = 1; i <= missingCount; i++){
      let prod = i < missingCount ? even : (missingSum - allocated);
      if (Math.abs(prod) < 1e-12) prod = 0;
      runningITD += prod;
      const parts = addDaysParts(lastParts, i);
      rows.push([ ymdToString(parts), Number(runningITD), Number(prod) ]);
      allocated += prod;
    }

    // Final input day must be the actual input date
    rows.push([ ymdToString(inputParts), Number(inputITD), Number(inputProd) ]);
    return rows;
  }

  // Render last row
  function renderLast(headers, row, index){
    const thead = document.getElementById('lastHead');
    const tbody = document.getElementById('lastBody');
    thead.innerHTML = ''; tbody.innerHTML = '';
    headers.forEach(h => {
      const th=document.createElement('th');
      th.className='p-2 text-left'; th.textContent=String(h||''); thead.appendChild(th);
    });
    if (row){
      for (let c=0;c<headers.length;c++){
        const td=document.createElement('td'); td.className='p-2 whitespace-nowrap';
        const raw=row[c];
        let v = raw == null ? '' : String(raw);
        const parts = c===0 ? parseCellDateToParts(v) : null;
        if (parts) v = ymdToString(parts);
        td.textContent = v;
        tbody.appendChild(td);
      }
      document.getElementById('rowMeta').textContent = `Last data row index by Column A: ${index}`;
    } else {
      const td = document.createElement('td'); td.className='p-2 text-sm text-gray-500'; td.colSpan=headers.length||1; td.textContent='No data rows yet'; tbody.appendChild(td);
      document.getElementById('rowMeta').textContent = '';
    }
  }

  async function loadLast(){
    const name = document.getElementById('sheetName').value.trim();
    document.getElementById('sheetLink').href = `https://docs.google.com/spreadsheets/d/${document.getElementById('sheetId').value.trim()}/edit#gid=0`;
    try{
      const values = await sheetsGet(`${name}!A1:C10000`);
      const r = findLastRowByA(values);
      renderLast(r.headers, r.row, r.index);
      log(`Loaded ${Math.max(0,(values||[]).length-1)} rows.`);
    } catch(e){
      log('Load failed: ' + e.message);
      alert('Load failed: ' + e.message);
    }
  }

  async function appendRow(){
    const name = document.getElementById('sheetName').value.trim();
    const inputDateStr = document.getElementById('inDate').value.trim(); // YYYY-MM-DD
    const inputITD = toNumber(document.getElementById('inITD').value.trim());
    const inputProd = toNumber(document.getElementById('inProd').value.trim());
    const status = document.getElementById('status');

    if (!inputDateStr || !Number.isFinite(inputITD) || !Number.isFinite(inputProd)){
      status.textContent = 'Enter a valid Date, ITD, and Prod'; status.className='text-sm bad'; return;
    }

    status.textContent = 'Calculating and writingâ€¦'; status.className='text-sm';
    try{
      const valuesABC = await sheetsGet(`${name}!A1:C10000`);
      const rowsToWrite = buildExtrapolatedRows(valuesABC, inputDateStr, inputITD, inputProd);

      await sheetsAppend(`${name}!A:C`, rowsToWrite);

      status.textContent = `Saved ${rowsToWrite.length} row(s)`; status.className='text-sm ok';
      document.getElementById('inDate').value = todayLocalYMD();
      document.getElementById('inITD').value=''; document.getElementById('inProd').value='';
      await loadLast();
    } catch(e){
      status.textContent = 'Append failed: ' + e.message; status.className='text-sm bad';
      log('Append failed: ' + e.message);
    }
  }

  // GIS init
  window.__gisLoaded = function(){
    try{
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SHEETS_SCOPE,
        callback: (resp) => {
          if (resp && resp.access_token){
            accessToken = resp.access_token;
            document.getElementById('whoAmI').textContent = 'Signed in';
            document.getElementById('appendBtn').disabled = false;
            loadLast();
          }
        }
      });
      log('GIS loaded');
    } catch(e){
      log('GIS init error: ' + e.message);
    }
  };

  function requestSignIn(){
    if (!tokenClient){
      log('Google Identity not ready yet.'); alert('Google Identity not ready yet.'); return;
    }
    tokenClient.requestAccessToken({ prompt: 'consent' });
  }

  // Wire up UI
  window.addEventListener('DOMContentLoaded', ()=>{
    log('JS ready');
    document.getElementById('inDate').value = todayLocalYMD();
    document.getElementById('sheetLink').href = `https://docs.google.com/spreadsheets/d/${document.getElementById('sheetId').value.trim()}/edit#gid=0`;

    document.getElementById('refreshBtn').addEventListener('click', ()=>{
      if (!accessToken){ alert('Sign in first to read via Sheets API.'); return; }
      loadLast();
    });
    document.getElementById('appendBtn').addEventListener('click', appendRow);
    document.getElementById('signInBtn').addEventListener('click', requestSignIn);

    const t = setInterval(()=>{
      if (window.google && google.accounts && google.accounts.oauth2){
        clearInterval(t);
        window.__gisLoaded();
      }
    }, 300);
  });
  </script>
</body>
</html>
