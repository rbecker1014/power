<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry — Last Row + Append (OAuth)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 16px rgba(0,0,0,.06); padding:1rem; }
    .input { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem; width:100%; }
    .mono  { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Data Entry</h1>
        <p class="text-gray-600 mt-1">Shows the last row where Column A has a value and appends a new row to the <span class="font-semibold">Data</span> sheet.</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <a href="index.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Dashboard</a>
        <a href="data.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">All Rows</a>
        <button id="signInBtn" class="px-4 py-2 rounded-xl bg-gray-900 text-white">Sign in</button>
        <span id="whoAmI" class="text-xs text-gray-600"></span>
      </div>
    </header>

    <!-- Connection -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Connection</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Google Sheet ID</span>
          <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac"/>
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Sheet name</span>
          <input id="sheetName" class="input" value="Data"/>
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <a id="sheetLink" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="modeChip" class="text-sm text-gray-600">Mode: Auto</span>
      </div>
    </section>

    <!-- Last row -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row on Data where Column A is not blank</h2>
      <div class="overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm" id="lastTable">
          <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
          <tbody><tr id="lastBody"></tr></tbody>
        </table>
      </div>
      <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
    </section>

    <!-- Append form -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Append a new row</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block"><span class="text-sm text-gray-700">Date (Column A)</span><input id="inDate" type="date" class="input"/></label>
        <label class="block"><span class="text-sm text-gray-700">ITD Production # (Column B)</span><input id="inITD" type="number" step="any" class="input" placeholder="e.g. 12345"/></label>
        <label class="block"><span class="text-sm text-gray-700">Daily Production (Column C)</span><input id="inProd" type="number" step="any" class="input" placeholder="kWh for the day"/></label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Append Row</button>
        <span id="status" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Append writes to the next row after the last non-empty cell in Column A. Requires Google sign in.</p>
    </section>

    <!-- Diagnostics -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <div id="diag" class="mono text-xs whitespace-pre-wrap"></div>
    </section>
  </div>

  <script>
    // ===== OAuth config: same client as your site =====
    const GOOGLE_CLIENT_ID = "656801194507-ujbqhlcm5ou4nqfq25c5j657jl6gnkoo.apps.googleusercontent.com";
    const SHEETS_SCOPE = "https://www.googleapis.com/auth/spreadsheets"; // read-write
    let accessToken = null;
    let tokenClient = null;

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    function diag(msg){ const d=$("diag"); d.textContent += msg + "\n"; }
    function setStatus(t, ok){ const el=$("status"); el.textContent=t; el.className="text-sm " + (ok ? "text-emerald-700" : "text-red-700"); }
    function sanitizeAntiXSSI(t){ return t.replace(/^\)\\]\\}'\\n/, "").replace(/^\\/\\*O_o\\*\\/\\n/, ""); }
    function parseGviz(text){
      const raw = sanitizeAntiXSSI(text);
      const m = raw.match(/google\\.visualization\\.Query\\.setResponse\\((.*)\\);?/s);
      if (!m) throw new Error("Unexpected GViz format");
      return JSON.parse(m[1]);
    }
    function gvizToValues(g){
      const cols = (g.table && g.table.cols ? g.table.cols : []).map(c => (c.label || c.id || "").trim());
      const rows = (g.table && g.table.rows ? g.table.rows : []).map(r => (r.c||[]).map(c => c && c.v!=null ? c.v : ""));
      return [cols, ...rows];
    }
    function excelSerialToDate(n){ const ms = (Number(n)-25569)*86400000; const d=new Date(ms); return isNaN(d)?null:d; }
    function parseMaybeDate(v){
      if (typeof v === "string"){
        const m = v.match(/^Date\\((\\d+),\\s*(\\d+),\\s*(\\d+)/); if (m){ const d=new Date(+m[1],+m[2],+m[3]); if(!isNaN(d)) return d; }
        const d1=new Date(v); if(!isNaN(d1)) return d1;
      }
      if (v && typeof v==="object" && v.year!=null){ const d2=new Date(v.year, v.month||0, v.day||1); if(!isNaN(d2)) return d2; }
      if (typeof v==="number"){ const d3=excelSerialToDate(v); if(d3) return d3; }
      return null;
    }
    function fmtDateCell(v){ const d=parseMaybeDate(v); return d ? d.toISOString().slice(0,10) : (v==null?"":String(v)); }

    function valuesToTable(headers, row){
      const thead = $("lastHead"); const tbody = $("lastBody");
      thead.innerHTML=""; tbody.innerHTML="";
      (headers||[]).forEach(h => { const th=document.createElement("th"); th.className="p-2 text-left"; th.textContent=String(h||""); thead.appendChild(th); });
      if (row){
        for (let c=0; c<(headers||[]).length; c++){
          const td=document.createElement("td"); td.className="p-2 whitespace-nowrap";
          const raw=row[c]; const v=(c===0)?fmtDateCell(raw):(raw==null?"":(typeof raw==="object"?JSON.stringify(raw):String(raw)));
          td.textContent=v; $("lastBody").appendChild(td);
        }
      } else {
        const td=document.createElement("td"); td.className="p-2 text-sm text-gray-500"; td.colSpan=(headers||[]).length||1; td.textContent="No data rows yet"; $("lastBody").appendChild(td);
      }
    }

    // ===== Loaders =====
    function buildGvizUrl(id, sheet){ const p=new URLSearchParams(sheet?{sheet}:{}) ; return "https://docs.google.com/spreadsheets/d/"+id+"/gviz/tq?"+p.toString(); }
    async function fetchValuesPublicGviz(spreadsheetId, sheetName){
      const url = buildGvizUrl(spreadsheetId, sheetName);
      const res = await fetch(url); const txt=await res.text();
      const g = parseGviz(txt);
      return gvizToValues(g); // [headers, ...rows]
    }
    async function fetchValuesPrivate(spreadsheetId, rangeA1){
      const url = "https://sheets.googleapis.com/v4/spreadsheets/"+spreadsheetId+"/values/"+encodeURIComponent(rangeA1)+"?majorDimension=ROWS";
      const res = await fetch(url, { headers: { Authorization: "Bearer " + accessToken } });
      if (!res.ok) throw new Error("Sheets API error "+res.status+": "+await res.text());
      const j = await res.json();
      return j.values || [];
    }

    // Find last row where Column A has a value (using a full table in values[][])
    function findLastRowByA(values){
      if (!values || values.length < 2) return { headers: values?.[0]||[], row: null, index: 0 };
      const headers = values[0];
      for (let i = values.length-1; i >= 1; i--){
        const row = values[i] || [];
        const a = row[0]; if (a!=null && String(a).trim()!=="") return { headers, row, index: i };
      }
      return { headers, row: null, index: 0 };
    }

    async function loadLast(){
      const id = $("sheetId").value.trim();
      const name = $("sheetName").value.trim();
      $("sheetLink").href = "https://docs.google.com/spreadsheets/d/"+id+"/edit#gid=0";
      try {
        let headers, row, index;
        if (accessToken){
          $("modeChip").textContent = "Mode: Private (Sheets API)";
          // Private full read for display
          const values = await fetchValuesPrivate(id, name+"!A1:Z10000");
          const r = findLastRowByA(values);
          headers = r.headers; row = r.row; index = r.index;
        } else {
          $("modeChip").textContent = "Mode: Public (GViz)";
          const values = await fetchValuesPublicGviz(id, name);
          const r = findLastRowByA(values);
          headers = r.headers; row = r.row; index = r.index;
        }
        valuesToTable(headers, row);
        $("rowMeta").textContent = "Last data row index (1-based) by Column A: " + index;
        diag("Loaded OK. Last row index: "+index);
      } catch(e){
        diag("Load failed: " + e.message);
        alert("Load failed: " + e.message);
      }
    }

    // ===== Append using Sheets API (requires sign in) =====
    async function findNextRowNumberPrivate(spreadsheetId, sheetName){
      // Read only Column A to find the next row after the last non-empty A cell.
      const values = await fetchValuesPrivate(spreadsheetId, sheetName+"!A:A");
      const colA = (values && values.length) ? values.map(r => r[0]) : [];
      // Assume row 1 is headers. Start from index 1.
      let lastNonEmpty = 0;
      for (let i = colA.length - 1; i >= 1; i--){
        if (colA[i] != null && String(colA[i]).trim() !== "") { lastNonEmpty = i + 1; break; } // convert to 1-based
      }
      const nextRow = Math.max(2, lastNonEmpty + 1);
      return nextRow;
    }

    async function appendRow(){
      const id = $("sheetId").value.trim();
      const name = $("sheetName").value.trim();
      const date = $("inDate").value.trim();
      const itd  = $("inITD").value.trim();
      const prod = $("inProd").value.trim();

      if (!date || itd === "" || prod === "") { setStatus("Please fill Date, ITD Production, and Daily Production.", false); return; }
      if (!accessToken){ setStatus("Sign in required to append.", false); return; }

      setStatus("Appending…", true);
      try {
        const target = await findNextRowNumberPrivate(id, name); // next row after last non-empty A
        const a1 = name + "!A" + target + ":C" + target;
        const url = "https://sheets.googleapis.com/v4/spreadsheets/"+id+"/values/"+encodeURIComponent(a1)+"?valueInputOption=USER_ENTERED";
        const body = { values: [[ date, Number(itd), Number(prod) ]] };

        const res = await fetch(url, {
          method: "PUT",
          headers: { Authorization: "Bearer " + accessToken, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("Append failed "+res.status+": "+await res.text());

        setStatus("Row appended at row "+target+".", true);
        $("inProd").value = ""; $("inITD").value = ""; $("inDate").value = new Date().toISOString().slice(0,10);
        await loadLast();
      } catch(e){
        setStatus("Append failed: " + e.message, false);
        diag("Append failed: " + e.message);
      }
    }

    // ===== Events and OAuth init =====
    window.addEventListener("load", () => {
      $("inDate").value = new Date().toISOString().slice(0,10);
      $("sheetLink").href = "https://docs.google.com/spreadsheets/d/"+$("sheetId").value.trim()+"/edit#gid=0";

      if (window.google && google.accounts && google.accounts.oauth2){
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: SHEETS_SCOPE,
          callback: (resp) => {
            if (resp && resp.access_token){
              accessToken = resp.access_token;
              $("whoAmI").textContent = "Signed in";
              loadLast();
            }
          }
        });
      }

      $("signInBtn").addEventListener("click", () => {
        if (!tokenClient){ alert("Google Identity not ready yet."); return; }
        tokenClient.requestAccessToken({ prompt: "consent" });
      });

      $("refreshBtn").addEventListener("click", loadLast);
      $("appendBtn").addEventListener("click", appendRow);

      loadLast();
    });
  </script>
</body>
</html>
