<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entry • Last Row and Append</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 16px rgba(0,0,0,.06);padding:1rem}
    .input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem;width:100%}
    .ok{color:#065f46}.bad{color:#991b1b}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Sheet Entry</h1>
      <nav class="flex gap-2 text-sm">
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="index.html">Dashboard</a>
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="data.html">All Rows</a>
      </nav>
    </header>

    <!-- Last non-empty row in Column A -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row (Column A not blank)</h2>
      <div id="lastRowBox" class="text-sm">
        <div class="grid grid-cols-3 gap-2">
          <div>
            <div class="text-gray-500">Date (A)</div>
            <div id="lastDate" class="font-medium">—</div>
          </div>
          <div>
            <div class="text-gray-500">ITD Production (B)</div>
            <div id="lastITD" class="font-medium">—</div>
          </div>
          <div>
            <div class="text-gray-500">Daily Production (C)</div>
            <div id="lastProd" class="font-medium">—</div>
          </div>
        </div>
        <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
      </div>
    </section>

    <!-- Append form -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Add new row</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <label class="block">
          <span class="text-sm text-gray-700">Date (A)</span>
          <input id="inDate" type="date" class="input" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">ITD Production (B)</span>
          <input id="inITD" type="number" step="any" class="input" placeholder="e.g. 12345" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Daily Production (C)</span>
          <input id="inProd" type="number" step="any" class="input" placeholder="kWh for the day" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Append</button>
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <span id="status" class="text-sm"></span>
      </div>
    </section>

    <!-- Minimal settings note (reads shared endpoint set on data.html) -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Connection</h2>
      <p class="text-sm text-gray-600">This page reads using the public GViz endpoint. Writing uses the same backend endpoint as <code>data.html</code>.
        If it is not set there, you can paste it here for convenience.</p>
      <div class="grid sm:grid-cols-2 gap-3 mt-2">
        <label class="block">
          <span class="text-sm text-gray-700">Append endpoint URL</span>
          <input id="appendUrl" class="input" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Shared secret</span>
          <input id="appendSecret" class="input" placeholder="optional" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="saveCfg" class="px-3 py-2 rounded-lg bg-gray-900 text-white">Save</button>
        <a id="sheetLink" href="#" target="_blank" class="px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="cfgStatus" class="text-sm"></span>
      </div>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <pre id="diag" class="text-xs text-gray-800 whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script>
    // ===== Sheet config (simple, hardcoded id and tab) =====
    const SHEET_ID = '193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac';
    const SHEET_NAME = 'Data';

    // ===== Shared storage keys (same as data.html) =====
    const ENDPOINT_KEYS = ['data:endpoint','append:endpoint','api:endpoint','backend:endpoint'];
    const SECRET_KEYS   = ['data:secret','append:secret','api:secret','backend:secret'];
    const readShared = (keys)=>{ for(const k of keys){ const v=localStorage.getItem(k); if(v) return v; } return ''; };
    const writeShared = (keys,v)=>{ keys.forEach(k=> v? localStorage.setItem(k,v): localStorage.removeItem(k)); };

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const diag = (m)=>{ const d=$('diag'); d.textContent += m + '\n'; };

    function buildGvizUrl(id, sheet){ const p = new URLSearchParams(sheet?{sheet}:{}) ; return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?${p.toString()}`; }
    function sanitizeAntiXSSI(t){ return t.replace(/^\)\]\}'\n/, '').replace(/^\/\*O_o\*\/\n/, ''); }
    function parseGviz(text){ const raw=sanitizeAntiXSSI(text); const m=raw.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s); if(!m) throw new Error('Unexpected GViz format'); return JSON.parse(m[1]); }
    function gvizToValues(g){ const cols=(g.table?.cols||[]).map(c=>(c.label||c.id||'').trim()); const rows=(g.table?.rows||[]).map(r=> (r.c||[]).map(c=> c && c.v!=null ? c.v : '')); return [cols, ...rows]; }

    function formatMaybeDate(v){ const d=new Date(v); return isNaN(d)? (v==null?'':String(v)) : d.toISOString().slice(0,10); }
    function findLastRowByColA(values){ if(!values || values.length<2) return {headers:values?.[0]||[], row:null, index:0}; const headers=values[0]; for(let i=values.length-1;i>=1;i--){ const row=values[i]||[]; if(row[0]!=='' && row[0]!=null) return { headers,row,index:i }; } return { headers,row:null,index:0 }; }

    function renderLast({headers,row,index}){
      $('lastDate').textContent = row? formatMaybeDate(row[0]) : 'None';
      $('lastITD').textContent  = row? (row[1] ?? '') : '';
      $('lastProd').textContent = row? (row[2] ?? '') : '';
      $('rowMeta').textContent = row? `Row ${index}` : 'No prior rows with a value in Column A';
    }

    async function loadLast(){
      $('sheetLink').href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=0`;
      try{
        const res = await fetch(buildGvizUrl(SHEET_ID, SHEET_NAME));
        const txt = await res.text();
        const g = parseGviz(txt);
        const values = gvizToValues(g);
        const last = findLastRowByColA(values);
        renderLast(last);
        diag(`Loaded ${Math.max(0,(values||[]).length-1)} rows.`);
      }catch(e){ diag('Load failed: ' + e.message); alert('Load failed: ' + e.message); console.error(e); }
    }

    // ===== Append via backend (uses same endpoint as data.html) =====
    async function appendViaServer(row){
      const endpoint = readShared(ENDPOINT_KEYS);
      const secret = readShared(SECRET_KEYS);
      if(!endpoint) throw new Error('No append endpoint configured. Open data.html or set it below and Save.');
      const payload = { spreadsheetId: SHEET_ID, sheetName: SHEET_NAME, row, secret, op: 'appendAtFirstEmptyA' };
      let res, text;
      try{
        res = await fetch(endpoint, { method:'POST', mode:'cors', credentials:'omit', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      }catch(err){ throw new Error('Network or CORS error: ' + err.message); }
      try{ text = await res.text(); }catch{ text = ''; }
      let data = null; try{ data = text ? JSON.parse(text) : null; }catch{}
      if(!res.ok){ throw new Error(`Server append failed ${res.status}. Body: ${text || '[no body]'}`); }
      return data || { ok:true };
    }

    async function handleAppend(){
      const date = $('inDate').value.trim();
      const itd  = $('inITD').value.trim();
      const prod = $('inProd').value.trim();
      const status = $('status');
      if(!date || itd==='' || prod===''){ status.textContent='Fill all three fields'; status.className='text-sm bad'; return; }
      status.textContent='Appending…'; status.className='text-sm';
      try{
        const row=[date, Number(itd), Number(prod)];
        await appendViaServer(row);
        status.textContent='Saved'; status.className='text-sm ok';
        $('inDate').value = todayISO(); $('inITD').value=''; $('inProd').value='';
        await loadLast();
      }catch(e){ status.textContent='Append failed: ' + e.message; status.className='text-sm bad'; diag('Append failed: ' + e.message); }
    }

    // ===== Config UI =====
    function loadCfgUI(){ $('appendUrl').value = readShared(ENDPOINT_KEYS); $('appendSecret').value = readShared(SECRET_KEYS); }
    function saveCfg(){ writeShared(ENDPOINT_KEYS, $('appendUrl').value.trim()); writeShared(SECRET_KEYS, $('appendSecret').value.trim()); $('cfgStatus').textContent='Saved'; setTimeout(()=>$('cfgStatus').textContent='', 1200); }

    // Quick setup via URL: ?append=...&secret=...
    function hydrateFromQuery(){ const q=new URLSearchParams(location.search); const ep=q.get('append'); const sec=q.get('secret'); if(ep){ writeShared(ENDPOINT_KEYS, ep); } if(sec){ writeShared(SECRET_KEYS, sec); } }

    // ===== Events and boot =====
    window.addEventListener('load', ()=>{
      $('inDate').value = todayISO();
      hydrateFromQuery();
      loadCfgUI();
      $('saveCfg').addEventListener('click', saveCfg);
      $('refreshBtn').addEventListener('click', loadLast);
      $('appendBtn').addEventListener('click', handleAppend);
      loadLast();
    });
  </script>
</body>
</html>
