<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry – No sign in append</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 16px rgba(0,0,0,.06); padding:1rem; }
    .input { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem; width:100%; }
    .chip { display:inline-block; border-radius:9999px; padding:.15rem .55rem; background:#f3f4f6; font-size:.75rem }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Data Entry – Data sheet</h1>
        <p class="text-gray-600 mt-1">Reads the last row based on Column A only and appends new rows without requiring sign in when a server endpoint is set.</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <a href="index.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Dashboard</a>
        <a href="data.html" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">All Rows</a>
        <span id="modeChip" class="chip">Append mode: Server</span>
      </div>
    </header>

    <!-- Sheet and server settings -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Settings</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Google Sheet ID</span>
          <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Sheet name</span>
          <input id="sheetName" class="input" value="Data" />
        </label>
        <label class="block sm:col-span-2">
          <span class="text-sm text-gray-700">Append endpoint URL (Apps Script web app or backend)</span>
          <input id="appendUrl" class="input" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec" />
          <p class="text-xs text-gray-500 mt-1">Must accept POST JSON with { spreadsheetId, sheetName, row, secret }. Enable CORS for your site.</p>
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Shared secret</span>
          <input id="appendSecret" class="input" placeholder="optional but recommended" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="saveCfg" class="px-4 py-2 rounded-xl bg-gray-900 text-white">Save</button>
        <a id="sheetLink" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="cfgStatus" class="text-sm"></span>
      </div>
    </section>

    <!-- Last row viewer -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row on Data (based on Column A only)</h2>
      <div class="overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
          <tbody><tr id="lastBody"></tr></tbody>
        </table>
      </div>
      <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
    </section>

    <!-- Append form -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Append a new row</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Date (Column A)</span>
          <input id="inDate" type="date" class="input" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">ITD Production # (Column B)</span>
          <input id="inITD" type="number" step="any" class="input" placeholder="e.g. 12345" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Production (Column C)</span>
          <input id="inProd" type="number" step="any" class="input" placeholder="kWh for the day" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Append Row</button>
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <span id="status" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Date is sent as YYYY-MM-DD and will be parsed by Sheets as a date when your endpoint uses USER_ENTERED.</p>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <div id="diag" class="mono text-xs whitespace-pre-wrap"></div>
    </section>
  </div>

  <script>
    // Small helpers
    const diag = (m) => { const d=document.getElementById('diag'); d.textContent += m + "\n"; };
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Public read via GViz
    function sanitizeAntiXSSI(t){ return t.replace(/^\)\]\}'\n/, '').replace(/^\/\*O_o\*\/\n/, ''); }
    function parseGviz(text){ const raw = sanitizeAntiXSSI(text); const m = raw.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s); if (!m) throw new Error('Unexpected GViz format'); return JSON.parse(m[1]); }
    function gvizToValues(g){ const cols=(g.table&&g.table.cols?g.table.cols:[]).map(c=>(c.label||c.id||'').trim()); const rows=(g.table&&g.table.rows?g.table.rows:[]).map(r=> (r.c||[]).map(c=> c && c.v!=null ? c.v : '')); return [cols, ...rows]; }
    function buildGvizUrl(id, sheet){ const qs = new URLSearchParams(sheet?{sheet}:{}) ; return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?${qs.toString()}`; }

    // Find last row by Column A only
    function hasValue(v){ return !(v == null || (typeof v === 'string' && v.trim() === '')); }
    function formatMaybeDate(v){ const d=new Date(v); return isNaN(d)? (v==null?'':String(v)) : d.toISOString().slice(0,10); }
    function findLastRowByColA(values){ if (!values || values.length < 2) return { headers: values && values[0] || [], row: null, index: 0 }; const headers = values[0]; for (let i=values.length-1; i>=1; i--){ const row=values[i]||[]; if (hasValue(row[0])) return { headers, row, index:i }; } return { headers, row:null, index:0 }; }

    function renderLastRowView(headers, row, index){ const head=document.getElementById('lastHead'); const body=document.getElementById('lastBody'); head.innerHTML=''; body.innerHTML=''; headers.forEach(h=>{ const th=document.createElement('th'); th.className='p-2 text-left'; th.textContent=String(h||''); head.appendChild(th); }); if (row){ for (let c=0; c<headers.length; c++){ const td=document.createElement('td'); td.className='p-2 whitespace-nowrap'; const raw=row[c]; const v = (c===0) ? formatMaybeDate(raw) : (raw==null?'':(typeof raw==='object'?JSON.stringify(raw):String(raw))); td.textContent=v; body.appendChild(td);} document.getElementById('rowMeta').textContent = `Last data row index (by Column A): ${index}`; } else { const td=document.createElement('td'); td.className='p-2 text-sm text-gray-500'; td.colSpan=headers.length||1; td.textContent='No rows with a value in Column A yet'; body.appendChild(td); document.getElementById('rowMeta').textContent=''; } }

    async function loadLast(){ const id=document.getElementById('sheetId').value.trim(); const name=document.getElementById('sheetName').value.trim(); document.getElementById('sheetLink').href=`https://docs.google.com/spreadsheets/d/${id}/edit#gid=0`; try { const res=await fetch(buildGvizUrl(id,name)); const txt=await res.text(); const g=parseGviz(txt); const values=gvizToValues(g); const { headers, row, index } = findLastRowByColA(values); renderLastRowView(headers, row, index); diag(`Loaded ${Math.max(0,(values||[]).length-1)} rows, ${headers.length} columns.`); } catch(e){ diag('Load failed: ' + e.message); alert('Load failed: ' + e.message); console.error(e); } }

    // Server append without sign in
    let APPEND_ENDPOINT = localStorage.getItem('append:endpoint') || '';
    let APPEND_SECRET   = localStorage.getItem('append:secret') || '';

    function loadCfgIntoUI(){ document.getElementById('appendUrl').value = APPEND_ENDPOINT; document.getElementById('appendSecret').value = APPEND_SECRET; }

    function saveCfg(){ APPEND_ENDPOINT = document.getElementById('appendUrl').value.trim(); APPEND_SECRET = document.getElementById('appendSecret').value.trim(); localStorage.setItem('append:endpoint', APPEND_ENDPOINT); localStorage.setItem('append:secret', APPEND_SECRET); document.getElementById('cfgStatus').textContent = APPEND_ENDPOINT ? 'Saved' : 'Saved - endpoint empty'; setTimeout(()=>document.getElementById('cfgStatus').textContent='', 1500); }

    async function appendViaServer(spreadsheetId, sheetName, row){ if (!APPEND_ENDPOINT){ throw new Error('No append endpoint configured.'); } const payload = { spreadsheetId, sheetName, row, secret: APPEND_SECRET }; const res = await fetch(APPEND_ENDPOINT, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); if (!res.ok){ throw new Error(`Server append failed ${res.status}: ${await res.text()}`); } return res.json(); }

    // Append handler
    async function handleAppend(){ const id=document.getElementById('sheetId').value.trim(); const name=document.getElementById('sheetName').value.trim(); const date=document.getElementById('inDate').value.trim(); const itd=document.getElementById('inITD').value.trim(); const prod=document.getElementById('inProd').value.trim(); const status=document.getElementById('status'); if (!date || itd==='' || prod===''){ status.textContent='Please fill date, ITD production, and production.'; return; } try { status.textContent='Appending...'; const row=[date, Number(itd), Number(prod)]; await appendViaServer(id, name, row); status.textContent='Row appended.'; document.getElementById('inProd').value=''; document.getElementById('inITD').value=''; document.getElementById('inDate').value=todayISO(); await loadLast(); } catch(e){ status.textContent = `Append failed: ${e.message}`; console.error(e); } }

    // Events and boot
    window.addEventListener('load', () => { document.getElementById('inDate').value = todayISO(); loadCfgIntoUI(); document.getElementById('saveCfg').addEventListener('click', saveCfg); document.getElementById('refreshBtn').addEventListener('click', loadLast); document.getElementById('appendBtn').addEventListener('click', handleAppend); loadLast(); });
  </script>
</body>
</html>
