<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry â€” OAuth Sheets API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="window.__gisLoaded && window.__gisLoaded()"></script>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 16px rgba(0,0,0,.06);padding:1rem}
    .input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem;width:100%}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    .ok{color:#065f46}.bad{color:#991b1b}
    .chip{display:inline-block;border-radius:9999px;padding:.15rem .55rem;background:#f3f4f6;font-size:.75rem}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl font-bold">Data Entry</h1>
      <nav class="flex items-center gap-2 text-sm">
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="index.html">Dashboard</a>
        <a class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" href="data.html">All Rows</a>
        <button id="signInBtn" class="px-3 py-1 rounded bg-gray-900 text-white">Sign in</button>
        <span id="whoAmI" class="chip">Signed out</span>
      </nav>
    </header>

    <!-- Connection -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Connection</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm text-gray-700">Google Sheet ID</span>
          <input id="sheetId" class="input" value="193i7rsk2zTJwrF9ahcGn5DDWuZqb2zsNL5oZ6y2XVac" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Sheet name</span>
          <input id="sheetName" class="input" value="Data" />
        </label>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Refresh</button>
        <a id="sheetLink" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Open Sheet</a>
        <span id="modeChip" class="text-sm text-gray-600">Mode: Private (Sheets API)</span>
      </div>
    </section>

    <!-- Last row -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Last row where Column A is not blank</h2>
      <div class="overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700"><tr id="lastHead"></tr></thead>
          <tbody><tr id="lastBody"></tr></tbody>
        </table>
      </div>
      <div id="rowMeta" class="text-xs text-gray-500 mt-2"></div>
    </section>

    <!-- Append -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Append a new row</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block"><span class="text-sm text-gray-700">Date (A)</span><input id="inDate" type="date" class="input" /></label>
        <label class="block"><span class="text-sm text-gray-700">ITD Production (B)</span><input id="inITD" type="number" step="any" class="input" placeholder="12345" /></label>
        <label class="block"><span class="text-sm text-gray-700">Daily Production (C)</span><input id="inProd" type="number" step="any" class="input" placeholder="kWh" /></label>
      </div>
      <div class="flex items-center gap-3 mt-4">
        <button id="appendBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700" disabled>Append Row</button>
        <span id="status" class="text-sm"></span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Writes to the first row with Column A empty. If no gaps exist, writes to the next new row at the bottom.</p>
    </section>

    <!-- Diagnostics -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Diagnostics</h2>
      <pre id="diag" class="mono text-xs whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script>
  'use strict';

  // OAuth config
  const GOOGLE_CLIENT_ID = "656801194507-ujbqhlcm5ou4nqfq25c5j657jl6gnkoo.apps.googleusercontent.com";
  const SHEETS_SCOPE = "https://www.googleapis.com/auth/spreadsheets";

  let accessToken = null;
  let tokenClient = null;

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const log = (m)=>{ const d=$('diag'); d.textContent += m + "\n"; };

  function setSignedInUI(isIn){
    $('whoAmI').textContent = isIn ? 'Signed in' : 'Signed out';
    $('appendBtn').disabled = !isIn;
  }

  async function sheetsGet(rangeA1){
    const id = $('sheetId').value.trim();
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1)}?majorDimension=ROWS`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error(`Sheets GET ${res.status}: ${await res.text()}`);
    const j = await res.json();
    return j.values || [];
  }

  async function sheetsUpdate(rangeA1, values2d){
    const id = $('sheetId').value.trim();
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(rangeA1)}?valueInputOption=USER_ENTERED`;
    const res = await fetch(url, {
      method: 'PUT',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: values2d })
    });
    if (!res.ok) throw new Error(`Sheets UPDATE ${res.status}: ${await res.text()}`);
    return res.json();
  }

  // Find last non-empty A for display
  function findLastRowByA(values){
    if (!values || values.length < 2) return { headers: values?.[0]||[], row: null, index: 0 };
    const headers = values[0];
    for (let i = values.length - 1; i >= 1; i--){
      const row = values[i] || [];
      const a = row[0];
      if (a != null && String(a).trim() !== '') return { headers, row, index: i };
    }
    return { headers, row: null, index: 0 };
  }

  // Find first empty A for writing
  function findFirstEmptyRowByA(values){
    // values is A1:Z... with headers at row 1
    if (!values || values.length === 0) return 2; // write on row 2
    // Ensure at least header row exists
    for (let i = 2; i <= values.length; i++){
      const row = values[i-1] || []; // 1-based to 0-based
      const a = row[0];
      if (a == null || String(a).trim()

